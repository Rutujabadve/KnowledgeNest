name: KnowledgeNest CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-backend:
    name: Test Backend Services
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: knowledge_nest_auth
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
      
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: knowledge_nest_courses
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Test Auth Service
      run: |
        cd services/auth_service
        pip install -r requirements.txt
        python -c "from app import app; print('Auth Service OK')"
    
    - name: Test Course Service
      run: |
        cd services/course_service
        pip install -r requirements.txt
        python -c "from app import app; print('Course Service OK')"
    
    - name: Test Review Service
      run: |
        cd services/review_service
        pip install -r requirements.txt
        python -c "from app import app; print('Review Service OK')"
    
    - name: Test API Gateway
      run: |
        cd api_gateway
        pip install -r requirements.txt
        python -c "from app import app; print('API Gateway OK')"

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: |
        cd frontend
        npm install
    
    - name: Build frontend
      run: |
        cd frontend
        npm run build

  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Build Auth Service
      run: docker build -t knowledgenest-auth services/auth_service
    
    - name: Build Course Service
      run: docker build -t knowledgenest-course services/course_service
    
    - name: Build Review Service
      run: docker build -t knowledgenest-review services/review_service
    
    - name: Build API Gateway
      run: docker build -t knowledgenest-gateway api_gateway
    
    - name: Build Frontend
      run: docker build -t knowledgenest-frontend frontend
    
    - name: Test Docker Compose
      run: |
        docker compose -f ci_cd/docker-compose.yml config

  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install flake8
      run: pip install flake8
    
    - name: Lint Python code
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 services/ api_gateway/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 services/ api_gateway/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
